name: Nightly Integration Tests

# Define the events that will trigger this workflow
on:
  # Schedule the workflow to run nightly at midnight
  schedule:
    - cron: '0 0 * * *'
  # Allow manual triggering of the workflow
  workflow_dispatch:
  # Trigger the workflow when there is a push to the integrate-tests branch
  push:
    branches:
      - integrate-tests

jobs:
  run-integration-tests:
    # Use the Docker image as the runner
    runs-on: ubuntu-latest
    container:
      image: docker:latest
      options: --privileged # Required for Docker-in-Docker

    env:
      OPEN_API_KEY: ${{ secrets.OPENAI_KEY }}

    steps:
    # Step 1: Check out the repository code
    - name: Checkout repository
      uses: actions/checkout@v2

    # Step 2: Install jq
    - name: Install jq
      run: |
        apt-get update && apt-get install -y jq

    # Step 3: Download latest release artifact
    - name: Download latest release artifact
      run: |
        # Fetch the latest release information from GitHub API
        latest_release_url=$(curl -s https://api.github.com/repos/Codium-ai/cover-agent/releases/latest | jq -r '.assets[] | select(.name == "cover-agent-ubuntu") | .browser_download_url')
        # Download the latest release artifact
        curl -L -o cover-agent-ubuntu $latest_release_url
        # Make the artifact executable
        chmod +x cover-agent-ubuntu
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Add this if the repository is private

    # Step 4: Run integration tests
    - name: Run integration tests
      run: |
        # Install bash
        apk add --no-cache bash
        # Execute the shell script with bash
        bash tests_integration/test_all.sh
