name: Nightly Integration Tests

# Define the events that will trigger this workflow
on:
  # Schedule the workflow to run nightly at midnight
  schedule:
    - cron: '0 0 * * *'
  # Allow manual triggering of the workflow
  workflow_dispatch:
  # Trigger the workflow when there is a push to the integrate-tests branch
  push:
    branches:
      - integrate-tests

jobs:
  run-integration-tests:
    # Use the Docker image as the runner
    runs-on: ubuntu-latest
    container:
      image: docker:latest
      options: --privileged # Required for Docker-in-Docker

    # Define the Docker service with Docker-in-Docker (DinD)
    services:
      docker:
        image: docker:latest
        options: --privileged # Required for Docker-in-Docker

    env:
      OPEN_API_KEY: ${{ secrets.OPENAI_KEY }}

    steps:
    # Step 1: Check out the repository code
    - name: Checkout repository
      uses: actions/checkout@v2

    # Step 2: Run integration tests
    - name: Run integration tests
      run: |
        # Install bash
        apk add --no-cache bash
        # Execute the shell script with bash
        bash tests_integration/test_all.sh
